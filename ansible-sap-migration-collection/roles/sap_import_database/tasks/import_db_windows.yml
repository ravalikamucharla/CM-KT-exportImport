---
- name: Enable insecure guest logons
  win_regedit:
     path: HKLM:\Software\Policies\Microsoft\Windows\Lanmanworkstation
     name: "AllowInsecureGuestAuth"
     data: "1"
     type: dword
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: Enable backconnectionhostnames
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
     name: "BackConnectionHostNames"
     data: ["{{ hostname }}","{{ hostname }}.azsqlha.cloudcoe.local"]
     type: MultiString
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: Enable DisableStrictNameChecking
  win_regedit:
     path: HKLM:\SYSTEM\CurrentControlSet\Services\lanmanserver\parameters
     name: "DisableStrictNameChecking"
     data: "1"
     type: dword
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: Enable firewall for Domain, Public and Private profiles
  win_firewall:
    state: disabled
    profiles:
    - Domain
    - Private
    - Public
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: Stopping all services and starting ascs and db
  vars:
    ansible_python_interpreter: /usr/bin/python3
    file_path:
      - mssql_db_actions.py
  set_fact:
    path_start_stop: "{{ lookup('first_found', file_path) }}"
  delegate_to: localhost
  tags: db_imp

- debug:
    var: path_start_stop
  delegate_to: localhost
  tags: db_imp

- command: python3 {{path_start_stop}} --hostname="{{ hostvars[groups['target_db'][0]].ansible_host }}" --username="azsqlha\cloudcoe" --password="P@ssw0rd1234" --loginMechanism="_NULL" --pemFile="_NULL" --isSudoUser="True" --dbSid="{{ sid|upper }}" --dbInstance="{{ instance_number }}" --action="START" --osType="{{ params.import.os_type }}" --ascs_instance="{{ ascs_instance_number }}"
  register: result
  delegate_to: localhost
  tags: db_imp

- debug: var=result
  delegate_to: localhost
  tags: db_imp

- name: Delete old logs files
  win_file:
    path: "C:\\Program Files\\sapinst_instdir"
    state: absent
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- win_file:
    path: "C:\\Users\\cloudcoe\\.sapinst"
    state: absent
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: Wait until the file DDLHDB.TPL is present before continuing
  vars:
    ansible_python_interpreter: /usr/bin/python
  wait_for:
    path: "{{ params.export.mainExportDir }}/ABAP/DB/DDLHDB.TPL"
    timeout: 14400
    msg: "Not able to find the file"
  delegate_to: "{{ source_hostname }}"
  tags: db_imp

- name: check for additional install items
  win_shell: (Get-Childitem –Path E:\SilentInstall\EXPORT\NetWeaver75\ABAP\ -Include *LABEL*.ASC -Recurse | Select-Object -Property Directory -unique).Directory.FullName
  register: sap_exports_folders
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- debug:
    var: sap_exports_folders
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: check for additional install items
  win_shell: (Get-Childitem –Path E:\SilentInstall\sybase -Include "*.ZIP" -Recurse | Select-Object -Property FullName).FullName
  register: sybase_software_path
  when: sybase is defined
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: main | set installation directory facts
  set_fact:
    sybase_zip_path: "{{ sybase_software_path.stdout_lines[0] }}"
  when: sybase is defined
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: create sapinst.params
  template:
    src: import_db_windows.j2
    dest: "E:\\{{ role }}_db_{{hostname}}.params"
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: set sapinst command line arguments
  set_fact:
    win_sap_install_arguments: >-
      SAPINST_INPUT_PARAMETERS_URL=E:\{{ role }}_db_{{ hostname }}.params
      SAPINST_CWD=E:\{{ role }}_db_Logs
      SAPINST_EXECUTE_PRODUCT_ID={{ params.product_ids.import_db }}
      SAPINST_USE_HOSTNAME={{ hostname }}
      SAPINST_SKIP_DIALOGS=true
      SAPINST_START_GUISERVER=true
      SAPINST_START_GUI=true
    win_sap_install_sapinst_path: "E:\\SilentInstall\\SWPM\\sapinst.exe"
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- debug: var=win_sap_install_arguments

- name: validate the required win_sap_install_arguments variable
  assert:
    that:
      - win_sap_install_arguments is defined
      - win_sap_install_arguments | length
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: validate that the path to sapinst.exe has been passed
  assert:
    that:
      - win_sap_install_sapinst_path is defined
      - win_sap_install_sapinst_path is regex('^.+sapinst.exe$')
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: stat the sapinst.exe path
  win_stat:
    path: "{{ win_sap_install_sapinst_path }}"
  register: win_sap_install_sapinst_stat
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

- name: validate that the sapinst.exe file exists
  assert:
    that:
      - win_sap_install_sapinst_stat.stat.exists
  tags: db_imp
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas

  # due to a known error the sap installation can fail in the initial attempt
  # however a subsequent installation can be successfully performed
  # based on the actions of the first installation attempt
  # therefor ignore_errors on install attempt one
- name: install sap
  vars:
    ansible_become_user: "{{ ansible_user }}"
    ansible_become_pass: "{{ ansible_password }}"
  win_sap_install:
    arguments: "{{ win_sap_install_arguments }}"
    checks: "{{ win_sap_install_checks }}"
    delay: "{{ win_sap_install_delay }}"
    path: "{{ win_sap_install_sapinst_path }}"
    sleep: "{{ win_sap_install_sleep }}"
    timeout: "{{ win_sap_install_timeout }}"
  register: win_sap_inst
  become: yes
  become_method: runas
  tags: db_imp

- name: debug win_sap_inst
  debug:
    var: win_sap_inst
    verbosity: "{{ verbosity_level }}"
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp

- name: fail if the installation failed other than the known issue
  fail:
    msg: "SAP installation failed"
  when:
    - win_sap_inst is failed
    - win_sap_inst.msg != 'The sapinst process was forcibly stopped'
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  tags: db_imp
